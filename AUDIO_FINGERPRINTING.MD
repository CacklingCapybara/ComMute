# Audio Fingerprinting Guide

ComMute now includes audio fingerprinting using Dejavu to identify known commercials by their audio signature. This provides more accurate detection than visual analysis alone.

## How It Works

1. **Fingerprint Known Commercials**: Record and fingerprint audio from commercials you want to detect
2. **Real-Time Matching**: ComMute continuously captures audio and compares it to fingerprinted commercials
3. **Instant Detection**: When a match is found, commercial probability jumps to 90%+ and triggers muting

## Benefits

- **Highly Accurate**: Audio fingerprints are unique and reliable
- **Works in Any Visual Context**: Detects commercials even during slow-paced ads
- **Persistent Database**: Once fingerprinted, commercials are recognized forever
- **Complementary**: Works alongside visual detection for best results

## Setup

### 1. Identify Your Audio Device

Your HDMI capture card should provide audio. Find the device:

```bash
# List audio devices
arecord -l

# Example output:
# card 1: U0x46d0x825 [USB Device 0x46d:0x825], device 0: USB Audio [USB Audio]
#   Subdevices: 1/1
```

Note the card and device numbers (e.g., `hw:1,0` for card 1, device 0).

### 2. Update Configuration

Edit `config/config.json`:

```json
{
  "audio_fingerprinting_enabled": true,
  "audio_device": "hw:1,0",
  "audio_check_interval": 3,
  "fingerprint_db_path": "/app/data/dejavu.db"
}
```

### 3. Test Audio Capture

```bash
# Record 5 seconds of audio to test
arecord -D hw:1,0 -f S16_LE -r 44100 -c 1 -d 5 test.wav

# Play it back to verify
aplay test.wav
```

## Fingerprinting Commercials

### Method 1: Record Live Commercials

1. **Capture a commercial as it airs**:
```bash
# Record 30 seconds of audio when a commercial is playing
arecord -D hw:1,0 -f S16_LE -r 44100 -c 1 -d 30 geico_commercial.wav
```

2. **Trim to just the commercial** (optional but recommended):
```bash
# Use ffmpeg to trim
ffmpeg -i geico_commercial.wav -ss 00:00:02 -t 00:00:25 geico_trimmed.wav
```

3. **Fingerprint it**:
```bash
# Copy file into container
docker cp geico_trimmed.wav commute:/tmp/

# Run fingerprinting
docker exec commute python commute.py --fingerprint /tmp/geico_trimmed.wav --name "Geico Insurance"
```

### Method 2: Use Existing Audio Files

If you have MP3/WAV files of commercials:

```bash
# Copy into container
docker cp commercial_audio.mp3 commute:/tmp/

# Fingerprint
docker exec commute python commute.py --fingerprint /tmp/commercial_audio.mp3 --name "Progressive Commercial"
```

### Method 3: Batch Fingerprinting

Create a directory of commercial audio files and fingerprint them all:

```bash
# Create commercials directory
mkdir -p commercials

# Add your audio files
# commercials/geico1.wav
# commercials/progressive1.mp3
# commercials/cocacola1.wav

# Fingerprint each one
for file in commercials/*; do
    filename=$(basename "$file" | cut -d. -f1)
    docker cp "$file" commute:/tmp/
    docker exec commute python commute.py --fingerprint "/tmp/$(basename $file)" --name "$filename"
done
```

## Building Your Commercial Database

### Finding Commercial Audio

**Option 1: Record from your own TV**
- Most reliable since you're detecting the exact commercials you see
- Record during commercial breaks
- Keep recordings of 15-30 seconds per commercial

**Option 2: Extract from recorded shows**
- If you have DVR recordings, extract commercial segments
- Use video editing software to isolate commercials

**Option 3: Online sources** (respect copyright)
- Some commercial archives exist online
- Ad agency showreels sometimes available

### Best Practices

1. **Quality matters**: Use at least 44.1kHz, 16-bit audio
2. **Clean recordings**: Minimize background noise
3. **Full commercials**: Capture the entire 15s or 30s spot
4. **Multiple versions**: Some commercials have slight variations - fingerprint each
5. **Update regularly**: Add new commercials as they appear

### Recommended Starting Point

Focus on the most frequent commercials first:
- Insurance companies (Geico, Progressive, State Farm)
- Pharmaceutical ads
- Car manufacturers
- Fast food chains
- Local commercials that repeat often

Even 10-20 fingerprinted commercials will significantly improve detection accuracy.

## Usage During Operation

Once fingerprinted, ComMute automatically:

1. **Captures audio** from the HDMI device every 3 seconds
2. **Checks for matches** against the fingerprint database
3. **Boosts probability** to 90%+ when a match is found
4. **Logs the match**:
   ```
   2025-10-21 14:23:45 - INFO - Audio fingerprint match detected! Confidence: 0.85
   2025-10-21 14:23:45 - INFO - Audio match found: Geico Insurance (confidence: 0.85)
   2025-10-21 14:23:46 - INFO - Commercial Probability: 92.3% ðŸŽµ| Status: COMMERCIAL | Audio: MUTED
   ```

The ðŸŽµ emoji indicates an audio match was detected.

## Monitoring

View real-time detection in the logs:

```bash
# Follow logs
docker-compose logs -f

# Or check the log file
tail -f logs/commute.log
```

Look for:
- `Commercial Probability: X%` - Updated every second
- `ðŸŽµ` symbol - Indicates audio match
- `Audio fingerprint match detected!` - Match found
- `Audio match found: [Name]` - Which commercial was matched

## Configuration Options

```json
{
  "audio_fingerprinting_enabled": true,     // Enable/disable feature
  "audio_device": "hw:1,0",                 // ALSA audio device
  "audio_check_interval": 3,                // Check every N seconds
  "fingerprint_db_path": "/app/data/dejavu.db"  // Database location
}
```

### Tuning

**Faster detection** (uses more CPU):
```json
"audio_check_interval": 1
```

**Slower detection** (uses less CPU):
```json
"audio_check_interval": 5
```

**Disable if not needed**:
```json
"audio_fingerprinting_enabled": false
```

## Troubleshooting

### No Audio Device Found

```bash
# Check if device exists
ls -l /dev/snd/

# Verify capture card provides audio
arecord -l
```

Make sure your capture card supports audio passthrough.

### Audio Not Matching

1. **Check audio quality**: Verify recordings are clear
2. **Volume levels**: Ensure captured audio isn't too quiet/distorted
3. **Timing**: Commercials must play for at least 3 seconds to match
4. **Variations**: Some commercials have multiple versions - fingerprint each

### High CPU Usage

Reduce check frequency:
```json
"audio_check_interval": 5
```

Or disable audio fingerprinting and use visual detection only.

### Database Issues

Reset the database if corrupted:
```bash
# Stop ComMute
docker-compose down

# Remove database
rm data/dejavu.db

# Restart and re-fingerprint commercials
docker-compose up -d
```

## Statistics

Track audio fingerprinting performance:

```bash
# View stats in logs
docker-compose logs | grep "Stats:"
```

Stats include:
- `audio_matches`: Number of successful fingerprint matches
- Can be compared to `commercials_detected` to see how many were audio-based

## Advanced: Automatic Learning

Future enhancement idea: Record all detected commercials automatically and prompt for fingerprinting.

## Performance Impact

- **CPU**: Minimal (~5-10% additional)
- **Memory**: ~50MB for database + buffers
- **Storage**: ~5-10KB per fingerprinted commercial

## FAQ

**Q: How many commercials should I fingerprint?**
A: Start with 20-30 of the most frequent ones. More is better, but diminishing returns after ~100.

**Q: Do I need to re-fingerprint periodically?**
A: Only when new commercials appear. Fingerprints are permanent.

**Q: Can I share my database?**
A: Yes! The `data/dejavu.db` file can be copied to other ComMute installations.

**Q: Does this work with streaming services?**
A: Yes, if you're capturing their output via HDMI.

**Q: What about regional commercials?**
A: Fingerprint the commercials that appear in your region.

**Q: How accurate is it?**
A: Very accurate (~95%+) when the audio quality is good and commercials are properly fingerprinted.

## Example Workflow

Complete example of setting up audio fingerprinting:

```bash
# 1. Find audio device
arecord -l
# Note: card 1, device 0 (hw:1,0)

# 2. Test audio capture
arecord -D hw:1,0 -f S16_LE -r 44100 -c 1 -d 5 test.wav
aplay test.wav

# 3. Update config
nano config/config.json
# Set audio_device to "hw:1,0"

# 4. Record some commercials
arecord -D hw:1,0 -f S16_LE -r 44100 -c 1 -d 30 geico.wav
arecord -D hw:1,0 -f S16_LE -r 44100 -c 1 -d 30 progressive.wav

# 5. Fingerprint them
docker cp geico.wav commute:/tmp/
docker exec commute python commute.py --fingerprint /tmp/geico.wav --name "Geico"

docker cp progressive.wav commute:/tmp/
docker exec commute python commute.py --fingerprint /tmp/progressive.wav --name "Progressive"

# 6. Restart ComMute
docker-compose restart

# 7. Watch the logs
docker-compose logs -f
```

Now ComMute will detect these commercials instantly when they play!

## Integration with Visual Detection

Audio fingerprinting works best when combined with visual detection:

- **Audio match**: Immediate 90%+ probability
- **Visual patterns**: Gradual probability increase
- **Both together**: Highest confidence and fastest muting

The system uses whichever signal is stronger, providing robust detection across different commercial types.